function makeUrl(a,b){var c=/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:\/?#[\]@!\$&'\(\)\*\+,;=.]+$/;if(!c.test(a))throw new Error("Invalid URL passed to makeUrl function: ",a);return'<a href="'+a+'">'+b+"</a>"}function ConvertDateFromDiv(a){var b=a.toString().split(" "),c=b[0].split("/"),d=c[2]+"/"+c[1]+"/"+c[0]+" "+b[1],e=new Date(d);return"Invalid Date"==e&&(e=new Date(a)),e.toLocaleDateString()}function getIcon(a){return a?'<i class="fa fa-check text-success fa-fw"></i>':'<i class="fa fa-times text-danger fa-fw"></i>'}function getStatusIcon(a){return"check"===a?'<i class="fa fa-exclamation text-warning fa-fw"></i>':"fail"===a?'<i class="fa fa-exclamation-triangle text-warning fa-fw"></i>':"error"===a?'<i class="fa fa-times text-danger fa-fw"></i>':"pass"===a?'<i class="fa fa-check text-success fa-fw"></i>':"error"}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function parseTeachers(a){var b=[];return Object.entries(a).forEach(function(a){var c=_slicedToArray(a,2),d=c[0],e=c[1];"teachers"===d&&Object.entries(e).forEach(function(a){var c=_slicedToArray(a,2),d=(c[0],c[1]);b+=d.firstname+" "+d.lastname+"<br>"})}),b}define(["core/ajax","jquery","block_filescan/jquery.dataTables","block_filescan/buttons.html5","block_filescan/dataTables.buttons","block_filescan/dataTables.select"],function(a,b){"use strict";function c(a,b){return null!=b&&"undefined"!=typeof Symbol&&b[Symbol.hasInstance]?!!b[Symbol.hasInstance](a):a instanceof b}function d(a,b){if(!c(a,b))throw new TypeError("Cannot call a class as a function")}function e(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function f(a,b,c){return b&&e(a.prototype,b),c&&e(a,c),a}var g=function(){function a(c){var e=c.id,f=c.value,g=c.type;d(this,a),this._value=f,this._type=g,this._el=b("<div>").addClass("overflow-hidden progress-bar bg-"+this._type).attr({id:e}).css({width:this._value})}return f(a,[{key:"update",value:function(a){var b=a.value,c=a.type;this._value=b,this._type=c,this._el.removeClass().addClass("overflow-hidden progress-bar bg-"+this._type).css({width:b})}},{key:"value",get:function(){return this._value}},{key:"el",get:function(){return this._el}}]),a}();return b.noConflict(!0),{init:function(){b(document).ready(function(){function c(){return a.call([{methodname:"block_filescan_request_files",args:{draw:1,columns:[{data:"status",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"hastext",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"hastitle",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"hasoutline",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"haslanguage",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"timechecked",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"courseinfo",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}}],order:[{column:0,dir:"asc"}],start:0,length:1,search:{value:"",regex:!1}}}])}function d(b){a.call([{methodname:"block_filescan_request_files",args:{draw:1,columns:[{data:"status",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"hastext",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"hastitle",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"hasoutline",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"haslanguage",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"timechecked",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}},{data:"courseinfo",name:"",searchable:!0,orderable:!0,search:{value:"",regex:!1}}],order:[{column:0,dir:"asc"}],start:0,length:b,search:{value:"",regex:!1}},done:function(a){const b=e(a.data);f(Date.now().toString()+"_filescan.csv",b)},fail:function(){g("Could not get data from the Moodle API!")}}])}function e(a){const b=[Object.keys(a[0])].concat(a);return b.map(function(a){return Object.values(a).toString()}).join("\n")}function f(a,b){var c=new Blob([b],{type:"text/csv"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(c,a);else{var d=window.document.createElement("a");d.href="data:text/csv;charset=utf-8,"+encodeURI(b),d.download=a,document.body.appendChild(d),d.click(),document.body.removeChild(d)}}function g(a){throw new Error(a)}const h=b("#view").DataTable({processing:!0,serverSide:!0,lengthMenu:[[50,100,200,-1],[50,100,200,"All"]],ajax:function(b,c,d){a.call([{methodname:"block_filescan_request_files",args:b,done:function(a){c(a)},fail:function(a){g("Could not get data from the Moodle API: ",a)}}])},select:!0,dom:"Blfrtip",buttons:["copy"],columnDefs:[{targets:"id",visible:!1}],columns:[{data:"status",className:"text-center",render:function(a){return getStatusIcon(a)}},{data:"hastext",className:"text-center",render:function(a){return getIcon(a)}},{data:"hastitle",className:"text-center",render:function(a){return getIcon(a)}},{data:"hasoutline",className:"text-center",render:function(a){return getIcon(a)}},{data:"haslanguage",className:"text-center",render:function(a){return getIcon(a)}},{data:"timechecked",className:"text-center",render:function(a){return ConvertDateFromDiv(Date.parse(a))}},{data:"courseinfo",render:function(a,c,d,e){var f="/course/view.php?id=";if(a){var g=JSON.parse(a),h=[];return g.forEach(function(a){var c=M.cfg.wwwroot+f+a.courseid||0,d=(a.student_enrollment||0,parseTeachers(a));if(a){var e=(b("<p></p>").text(makeUrl(c,a.shortname)),"<p>"+makeUrl(c,a.shortname)+"</p>"),g='<p><i class="fa fa-chalkboard-teacher mr-1"></i>'+d+"</p>",i='<p class="mb-1">'+makeUrl(M.cfg.wwwroot+"/mod/resource/view.php?id="+a.instance_id,a.filename)+"</p>";h.push(e+g+i)}else h.push("No course information found. This may be an invalid courseinfo                         entry within the block_filescan_files table.")}),h.join("<br>")}return"No response returned from the DataTables service.                   Are you sure the course exists?<br><strong>Ref id: "+d.id+"</strong>"}}]});b("#btn-reload").on("click",function(){h.ajax.reload()}),b("#btn-export-csv").on("click",function(){b("#btn-export-csv").prop({disabled:!0});var a=c()[0];a.done(function(a){b("#btn-export-csv").prop({disabled:!1});const c=a.recordsTotal;d(c)}).fail(function(a){b("#btn-export-csv").prop({disabled:!1}),g(a)})})})},progress:function(a,c,d,e,f){function h(a,b){return Math.round(a/b*100)+"%"}var i=b("#stats-text"),j=b("#stats-title"),k=b("#stats-language"),l=b("#stats-outline"),m=new g({value:h(0,100),type:"primary"}),n=new g({value:h(0,100),type:"primary"}),o=new g({value:h(0,100),type:"primary"}),p=new g({value:h(0,100),type:"primary"});i.append(m.el),j.append(n.el),k.append(o.el),l.append(p.el),setTimeout(function(){m.update({value:h(a,f),type:"primary"}),m.el.text(a+" / "+f+" pdfs have text"),n.update({value:h(c,f),type:"primary"}),n.el.text(c+" / "+f+" pdfs have a title"),o.update({value:h(d,f),type:"primary"}),o.el.text(d+" / "+f+" pdfs have a language"),p.update({value:h(e,f),type:"primary"}),p.el.text(e+" / "+f+" pdfs have an outline")},500)}}});